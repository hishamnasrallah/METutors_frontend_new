<form [formGroup]="form" (ngSubmit)="submitFormData()" class="w-100">
  <div>
    <h4 class="mb-5 heading text-center">PROVIDE YOUR TUTORING COURSES</h4>

    <div class="row" formArrayName="programs">
      <ng-container *ngFor="let _ of programs.controls; let i = index" [formGroupName]="i">
        <div class="col-md-6">
          <div class="form-group">
            <label for="program" class="form-label d-flex justify-content-between">
              Program Name
              <a class="float-end cursor-pointer" *ngIf="i !== 0" (click)="removeProgram(i)">
                <mat-icon>delete</mat-icon>
              </a>

              <a class="float-end cursor-pointer" *ngIf="i === 0 && programs.controls.length < programsList.length"
                (click)="addProgram()">
                Add new
              </a>
            </label>

            <mat-form-field appearance="outline" class="w-100">
              <mat-select formControlName="programId" [placeholder]="'Select Program'"
                (selectionChange)="onChangeProgram($event, i)">
                <ng-container *ngFor="let program of programsList">
                  <mat-option [value]="program" [hidden]="!checkProgram(program.id)">
                    {{ program?.name }}
                  </mat-option>
                </ng-container>
              </mat-select>
            </mat-form-field>
            <!-- <div class="text-danger" *ngIf="programId?.touched && programId?.invalid">
              Please write your Program
            </div> -->

            <ng-container *ngIf="form.value.programs[i]?.programId?.id === nationalId">
              <label for="program" class="form-label mt-3">
                Country for {{ form.value.programs[i]?.programId?.name }} Program
              </label>
              <mat-form-field appearance="outline" class="w-100">
                <mat-select formControlName="countries" [placeholder]="'Select Countries'" multiple>
                  <mat-option [value]="country?.id" *ngFor="let country of countries">{{ country?.name }}</mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="w-100">
                <mat-select formControlName="grades" [placeholder]="'Select Grades'" multiple>
                  <mat-option [value]="i + 1" *ngFor="let grade of grades; let i = index">{{ grade }}</mat-option>
                </mat-select>
              </mat-form-field>
            </ng-container>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-group">
            <div>
              <label for="subjects" class="form-label">Fields of Study <span>(you can Select multiple)</span></label>
            </div>

            <mat-form-field appearance="outline" class="w-100">
              <mat-select formControlName="fields" [placeholder]="'Select Field'" multiple>
                <ng-container *ngFor="let field of fields">
                  <mat-option [value]="field?.id" *ngIf="
                    (
                      form.value.programs[i]?.programId?.id !== nationalId && 
                      form.value.programs[i]?.programId?.id === field?.programId
                    ) || 
                    (
                      form.value.programs[i]?.programId?.id === nationalId && 
                      form.value.programs[i]?.programId?.id === field?.programId &&
                      form.value.programs[i].countries?.includes(field.countryId) &&
                      form.value.programs[i].grades?.includes(field.grade)
                    )
                  ">
                    {{ field?.name }}
                  </mat-option>
                </ng-container>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-100">
              <mat-select formControlName="subjects" [placeholder]="'Select Subject'" (selectionChange)="onChange(i)"
                multiple>
                <ng-container *ngFor="let subject of subjects">
                  <mat-optgroup [label]="subject.fieldName" *ngIf="
                    (
                      form.value.programs[i]?.programId?.id !== nationalId && 
                      form.value.programs[i]?.programId?.id === subject.programId && 
                      form.value.programs[i].fields?.includes(subject.fieldId)
                    ) ||
                    (
                      form.value.programs[i]?.programId?.id === nationalId && 
                      form.value.programs[i]?.programId?.id === subject.programId && 
                      form.value.programs[i].fields?.includes(subject.fieldId) &&
                      form.value.programs[i].countries?.includes(subject.countryId) &&
                      form.value.programs[i].grades?.includes(subject.grade)
                    )
                  ">
                    <mat-option *ngFor="let sub of subject.subjects" [value]="sub">
                      {{ sub?.name }}
                    </mat-option>
                  </mat-optgroup>
                </ng-container>
              </mat-select>
            </mat-form-field>

            <table class="table my-table default-title"
              *ngIf="form.value.programs[i].sortedSubjects && form.value.programs[i].sortedSubjects.length">
              <ng-container *ngFor="let item of form.value.programs[i].sortedSubjects; let indexSubjects = index">
                <tr>
                  <th class="heading" [attr.colspan]="form.value.programs[i]?.programId?.id === nationalId ? '2' : '1'">
                    Program <span>
                      {{ form.value.programs[i]?.programId?.name }}<ng-container
                        *ngIf="form.value.programs[i]?.programId?.id === nationalId">, {{ item?.countryName }}
                      </ng-container>
                    </span>
                  </th>
                  <th class="heading text-end">Field Name <span>{{ item?.fieldName }}</span></th>
                </tr>
                <tr>
                  <th>Subject Name</th>
                  <th *ngIf="form.value.programs[i]?.programId?.id === nationalId">Grade</th>
                  <th>Hourly Price</th>
                </tr>
                <tr *ngFor="let subject of item.subjects; let indexSubject = index">
                  <td>{{ subject?.name }}</td>
                  <td *ngIf="form.value.programs[i]?.programId?.id === nationalId">{{ subject?.gradeName }}</td>
                  <td>
                    <input type="number" min="1" step="1" max="20" placeholder="Enter Price" class="p-0 w-100"
                      [value]="subject.pricePerHour" (change)="changePrice(i, indexSubjects, indexSubject, $event)">
                  </td>
                </tr>
              </ng-container>
            </table>
          </div>
        </div>
      </ng-container>
    </div>

    <div class="row">
      <div class="col-md-4"></div>
      <div class="col-md-4">
        <div class="form-group mt-4 mb-2">
          <metutors-submit-button [form]="form" [isSubmitting]="loading" [extraClasses]="'w-100 fw-bold'">
            Save & Continue
          </metutors-submit-button>
        </div>
      </div>
      <div class="col-md-4"></div>
    </div>
  </div>
</form>
